---
- name: Setup Certbot for SSL
  hosts: web_sites
  become: yes
  vars:
    domain: domain.name.net # Replace with the appropriate IP address
    wordpress_admin_email: mail@mail.com
    php_version: "8.2"

  pre_tasks:
    - name: Ensure services are enabled to start at boot
      service:
        name: "{{ item }}"
        enabled: yes
      loop:
        - nginx
        - mariadb
        - "php{{ php_version }}-fpm"

  tasks:
    # Ensure FastCGI configuration is present
    - name: Ensure fastcgi_params file exists
      template:
        src: templates/fastcgi_params.j2
        dest: /etc/nginx/fastcgi_params
      notify: Reload Nginx

    - name: Ensure fastcgi-php.conf snippet for Nginx exists
      template:
        src: templates/fastcgi-php.conf.j2
        dest: /etc/nginx/snippets/fastcgi-php.conf
      notify: Reload Nginx

    # Create Let's Encrypt directory and SSL options
    - name: Create Let's Encrypt directory
      file:
        path: /etc/letsencrypt
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Ensure Let's Encrypt SSL options file exists
      template:
        src: templates/options-ssl-nginx.conf.j2
        dest: /etc/letsencrypt/options-ssl-nginx.conf

    - name: Ensure dhparams.pem file exists
      command: openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
      args:
        creates: /etc/letsencrypt/ssl-dhparams.pem

    # Clean up existing Let's Encrypt live directory
    - name: Remove existing Let's Encrypt live directory (if exists)
      file:
        path: /etc/letsencrypt/live/{{ domain }}
        state: absent
      ignore_errors: yes

    # Create Let's Encrypt live directory structure
    - name: Create Let's Encrypt live directory structure
      file:
        path: /etc/letsencrypt/live/{{ domain }}
        state: directory
        mode: '0755'
        owner: root
        group: root

    # Generate a self-signed certificate as a placeholder
    - name: Generate self-signed certificate
      command: >
        openssl req -x509 -nodes -days 1 -newkey rsa:2048
        -keyout /etc/letsencrypt/live/{{ domain }}/privkey.pem
        -out /etc/letsencrypt/live/{{ domain }}/fullchain.pem
        -subj "/CN={{ domain }}"
      args:
        creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

    # Install Certbot and required plugins
    - name: Install Certbot and nginx plugin
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: present

    # Configure Nginx for WordPress
    - name: Configure Nginx for WordPress
      template:
        src: templates/nginx_wordpress_ssl.j2
        dest: /etc/nginx/sites-available/wordpress
      notify: Reload Nginx

    - name: Enable WordPress Nginx site
      file:
        src: /etc/nginx/sites-available/wordpress
        dest: /etc/nginx/sites-enabled/wordpress
        state: link
      notify: Reload Nginx

    # Test Nginx configuration to ensure it's valid
    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      failed_when: nginx_test.rc != 0
      notify: Reload Nginx

    - name: Obtain SSL certificate using Certbot
      command: certbot --nginx -d {{ domain }} --non-interactive --agree-tos --email {{ wordpress_admin_email }}
      register: certbot_output
      failed_when: certbot_output.rc != 0

    - name: Print Certbot output
      debug:
        var: certbot_output

  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded
